# 機能仕様: AWS DynamoDB Clock Table CI/CD

**機能ブランチ**: `copilot/build-ci-for-aws-deployment`  
**作成日**: 2025-12-24  
**ステータス**: 下書き  
**入力**: ユーザー説明: "AWSにDynamoDBの打刻テーブル(clock)をデプロイするCI/CDをCDKで構築"

<!--
  🌏 言語ポリシー:
  - この仕様書は日本語で記述してください
  - ユーザーストーリー、要件、説明は日本語で
  - 技術用語は英語を併記しても構いません
-->

## ユーザーシナリオとテスト *(mandatory)*

### ユーザーストーリー 1 - インフラストラクチャの自動デプロイ (優先度: P1)

システム管理者として、GitHub ActionsとAWS CDKを使用してDynamoDBの打刻テーブルを自動的にデプロイしたい。これにより、手動でのAWSコンソール操作を避け、インフラストラクチャをコードとして管理できる。

**この優先度の理由**: インフラストラクチャの基盤となる部分であり、他の機能開発の前提条件となるため最優先。自動化により、環境の再現性と信頼性が確保される。

**独立テスト**: GitHub Actionsワークフローを手動で実行し、DynamoDBテーブルが正しく作成されることをAWSコンソールで確認することで完全にテスト可能。

**受け入れシナリオ**:

1. **前提** インフラストラクチャコードの変更をmainブランチにマージする, **実行** GitHub Actionsワークフローが自動実行される, **結果** DynamoDBテーブル "attendance-kit-dev-clock" がAP-NORTHEAST-1リージョンに正常に作成される
2. **前提** GitHub Actionsの手動トリガー画面を開く, **実行** "dev"環境を選択してワークフローを実行する, **結果** ワークフローが成功し、CloudFormationスタックがデプロイされる
3. **前提** 既存のDynamoDBテーブルが存在する, **実行** インフラストラクチャコードを更新してデプロイを実行する, **結果** テーブルが安全に更新される（RETAIN削除ポリシーによりデータは保護される）

---

### ユーザーストーリー 2 - セキュアなAWS認証 (優先度: P1)

システム管理者として、AWSアクセスキーをGitHubに保存せずに、CDK内でOIDCプロバイダーとIAMロールを管理してGitHub ActionsからAWSに安全に接続したい。これにより、認証情報の漏洩リスクを最小化し、インフラストラクチャとして一元管理できる。

**この優先度の理由**: セキュリティは最優先事項であり、認証情報の漏洩は重大なセキュリティインシデントにつながる可能性がある。CDKで管理することで、OIDC設定の再現性と保守性が向上する。

**独立テスト**: CDKでOIDCプロバイダーとIAMロールをデプロイし、GitHub Actionsワークフローを実行してAWSリソースにアクセスできることを確認することでテスト可能。

**受け入れシナリオ**:

1. **前提** CDKでOIDCプロバイダーとIAMロールがデプロイされている, **実行** GitHub Actionsワークフローを実行する, **結果** 一時的な認証情報でAWSに接続し、デプロイが成功する
2. **前提** CDKスタックの出力にロールARNが含まれている, **実行** ワークフローがOIDC認証を試みる, **結果** 正常に認証され、永続的な認証情報は使用されない
3. **前提** 初回はCloudFormationでOIDCを設定, **実行** CDKでOIDCとロールをデプロイ, **結果** CloudFormationスタックを削除し、以降はCDK管理のOIDCを使用

---

### ユーザーストーリー 3 - テーブル設計の理解 (優先度: P2)

アプリケーション開発者として、打刻テーブルのスキーマ、クエリパターン、制約を理解したい。これにより、効率的にデータの読み書きを実装できる。

**この優先度の理由**: アプリケーション開発の前提となる知識だが、インフラストラクチャが先に構築されれば後から確認可能なため、P2とする。

**独立テスト**: ドキュメントを読み、サンプルデータを使用してDynamoDBテーブルへの読み書きを実行することでテスト可能。

**受け入れシナリオ**:

1. **前提** ドキュメント "aws-deployment.md" を開く, **実行** テーブルスキーマのセクションを読む, **結果** Partition Key、Sort Key、GSIの構成が理解できる
2. **前提** サンプルデータをテーブルに書き込む, **実行** userIdとtimestampを使用してクエリを実行する, **結果** 期待通りのデータが取得できる
3. **前提** 特定日付のデータを取得したい, **実行** DateIndex GSIを使用してクエリを実行する, **結果** 指定日付の全打刻記録が効率的に取得できる

---

### エッジケース

- テーブルが既に存在する場合、デプロイはどう動作するか？
  → CloudFormationが既存リソースを検出し、差分更新を実行する。RETAIN削除ポリシーによりデータは保護される。

- デプロイ中にエラーが発生した場合、どう処理されるか？
  → CloudFormationが自動的にロールバックを実行し、前の安定状態に戻る。GitHub Actionsワークフローはエラーログを出力する。

- 同時に複数のデプロイが実行された場合は？
  → CloudFormationのスタックロックにより、同時実行は防止される。後続のデプロイは待機またはエラーとなる。

- GSI用のdate属性が設定されていないアイテムが書き込まれた場合は？
  → DynamoDBはスパースインデックスとして扱い、date属性を持つアイテムのみがGSIに含まれる。アプリケーションはdate属性を必ず設定する責任がある。

- CDK bootstrapが必要な環境でデプロイした場合は？
  → デプロイワークフローがbootstrapを自動実行し、必要なリソースを準備する。既にbootstrap済みの場合は冪等性により既存リソースがそのまま使用される。

- CDK synthでエラーが発生した場合は？
  → TypeScriptのコンパイルエラーまたはCDK構文エラーがログに出力され、ワークフローが失敗する。テンプレートは生成されない。

## 要件 *(mandatory)*

### 機能要件

- **FR-001**: システムはAWS CDKを使用してDynamoDBテーブル "attendance-kit-dev-clock" をデプロイできなければならない
- **FR-002**: テーブルはPartition Key "userId" (String) とSort Key "timestamp" (String, ISO 8601形式の日時文字列) を持たなければならない
- **FR-003**: テーブルはGlobal Secondary Index "DateIndex" を持ち、Partition Key "date" (String, ISO 8601形式の日付文字列) とSort Key "timestamp" (String, ISO 8601形式の日時文字列) でクエリ可能でなければならない
- **FR-004**: テーブルはOn-Demand課金モード (PAY_PER_REQUEST) で作成されなければならない
- **FR-005**: テーブルはPoint-in-Time Recovery (PITR) が有効化されていなければならない
- **FR-006**: テーブルはAWS管理キーによる暗号化が設定されていなければならない
- **FR-007**: テーブルはREMOVAL_POLICY: RETAINが設定され、CloudFormationスタック削除時もテーブルが保持されなければならない
- **FR-008**: GitHub ActionsワークフローはOIDC認証を使用してAWSに接続しなければならない
- **FR-008a**: CDKはIAM OIDCプロバイダーとGitHub Actions用のIAMロールを管理しなければならない
- **FR-008b**: 初回セットアップはCloudFormationテンプレートを使用してOIDCを設定し、CDKデプロイ後はCDK管理のOIDCを使用し、CloudFormationスタックを削除しなければならない
- **FR-009**: ワークフローは手動トリガー (workflow_dispatch) と自動トリガー (infrastructure/配下の変更時) をサポートしなければならない
- **FR-010**: ワークフローはNode.js 22環境でCDKプロジェクトをビルドおよびデプロイしなければならない
- **FR-011**: CloudFormationの出力として、テーブル名、テーブルARN、およびIAMロールARNが提供されなければならない
- **FR-012**: デプロイワークフローはCDK bootstrapを自動実行しなければならない（環境が未初期化の場合に対応）
- **FR-013**: Bootstrap処理は冪等性を持ち、既にbootstrap済みの環境でも安全に実行できなければならない
- **FR-014**: 初期段階ではコスト削減のため、CloudWatchアラーム（スロットルなど）や有料の監視機能を含めてはならない

### 主要エンティティ

- **Clock Record (打刻記録)**: ユーザーの出退勤を記録するエンティティ
  - userId: ユーザーを識別する一意のID
  - timestamp: 打刻時刻 (ISO 8601形式)
  - date: 日付 (YYYY-MM-DD形式、GSI用にtimestampから導出)
  - type: 打刻種別 (clock-in / clock-out)
  - location: 打刻場所（オプション）
  - deviceId: 打刻デバイスID（オプション）

- **CDK Stack**: インフラストラクチャを定義するエンティティ
  - Stack Name: SpecKitDevStack
  - Region: ap-northeast-1
  - Resources: DynamoDB Table
  - Outputs: Table Name, Table ARN

## 成功基準 *(mandatory)*

### 測定可能な成果

- **SC-001**: GitHub Actionsワークフローを実行してから5分以内にDynamoDBテーブルが作成される
- **SC-002**: デプロイの成功率が95%以上である（ネットワークエラーなどの一時的な障害を除く）
- **SC-003**: テーブルのREMOVAL_POLICY設定により、誤ってCloudFormationスタックを削除してもデータは保持される
- **SC-004**: OIDCを使用することで、永続的なAWSアクセスキーがGitHubリポジトリに保存されない（セキュリティスキャンで検証）
- **SC-005**: CDKコードの変更をmainブランチにマージすると、10分以内に自動デプロイが完了する（bootstrap含む）
- **SC-006**: ドキュメントを読むことで、開発者がテーブルスキーマとクエリパターンを30分以内に理解できる
- **SC-007**: デプロイワークフローは未初期化環境でも自動的にbootstrapを実行し、エラーなくデプロイが完了する

## 前提条件

- AWSアカウントが存在する
- 初回セットアップ時に、CloudFormationを使用してOIDCプロバイダーとIAMロールを設定する権限がある（その後CDKで管理）
- Node.js 22がGitHub Actionsランナーで利用可能である

## スコープ内

- DynamoDBの打刻テーブル（clock）のみ
- dev および staging 環境
- GitHub Actions経由の自動デプロイ（bootstrap含む）
- CDK管理によるOIDC認証（初回のみCloudFormationでセットアップ、以降はCDK管理）
- コスト削減のための監視機能の最小化（CloudWatchアラームなし）

## スコープ外

- アプリケーションコードの実装（打刻機能のロジック）
- API Gateway / Lambda の実装
- 認証・認可の実装
- CloudWatchアラームおよび有料監視機能（コスト削減のため初期段階では除外）
- データマイグレーション
- 本番環境の構築（devおよびstaging環境のみ）
- 他のDynamoDBテーブル（休暇申請テーブルなど）
