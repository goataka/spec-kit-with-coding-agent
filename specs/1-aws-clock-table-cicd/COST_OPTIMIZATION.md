# コスト最適化戦略

## 概要

このドキュメントは、AWS DynamoDB Clock Table CI/CDシステムのコスト最適化戦略を説明します。初期段階では、必要最小限のリソースのみをデプロイし、有料監視機能を除外することでコストを削減します。

## コスト削減の方針

### 原則

1. **無料枠の活用**: AWSの無料利用枠を最大限活用する
2. **段階的な拡張**: 初期段階では最小限の機能のみを実装し、必要に応じて段階的に拡張する
3. **コスト可視化**: AWS Cost Explorerとタグを使用してコストを追跡する
4. **必要な機能から**: ビジネスクリティカルな機能を優先し、監視・アラートは後回し

## 初期段階で除外する機能

### 1. CloudWatch アラーム（除外）

**理由**: CloudWatchアラームは1つあたり月額$0.10の費用がかかります。初期段階では不要。

**除外するアラーム**:
- スロットルアラーム（読み取り）
- スロットルアラーム（書き込み）
- システムエラーアラーム
- ユーザーエラーアラーム

**代替手段**:
- CloudWatchメトリクスを手動で確認（無料）
- GitHub Actionsのデプロイログを確認
- 問題発生時にAWSコンソールで調査

**将来の実装**:
- システムが安定稼働し、予算に余裕が出たら実装を検討
- 本番環境では優先度を上げて実装

### 2. SNS通知（除外）

**理由**: SNSトピックとSMS/Email通知にコストがかかります。

**除外する通知**:
- アラーム通知
- デプロイ通知
- システム障害通知

**代替手段**:
- GitHub Actionsの通知機能を活用
- AWSコンソールで手動確認
- CloudWatchログを定期的にレビュー

### 3. カスタムメトリクス（除外）

**理由**: カスタムメトリクスは追加コストがかかります。

**除外するメトリクス**:
- アプリケーション固有のメトリクス
- 詳細なパフォーマンスメトリクス

**代替手段**:
- 基本メトリクスのみを使用（無料）
- アプリケーションログで分析

### 4. 詳細モニタリング（除外）

**理由**: 詳細モニタリング（1分間隔）は追加コストがかかります。

**除外する機能**:
- 1分間隔のメトリクス収集
- リアルタイムダッシュボード

**代替手段**:
- 標準モニタリング（5分間隔、無料）で十分

## 実装する機能（コスト最小）

### 1. DynamoDB On-Demand課金

**選択理由**:
- 使用量に応じた従量課金
- 低トラフィック時のコスト効率が高い
- 初期投資不要

**想定コスト**:
```
開発環境（dev）:
- 書き込み: 月100リクエスト × $1.25/100万 ≈ $0.0001
- 読み取り: 月1,000リクエスト × $0.25/100万 ≈ $0.0002
- ストレージ: 1GB × $0.25/GB ≈ $0.25
合計: 約 $0.25/月
```

### 2. Point-in-Time Recovery (PITR)

**選択理由**:
- データ保護の必須機能
- 比較的低コスト

**想定コスト**:
```
PITR: テーブルサイズ × $0.20/GB
1GBの場合: $0.20/月
```

### 3. AWS管理キーによる暗号化

**選択理由**:
- セキュリティ要件
- 追加コストなし（AWSマネージドキー使用時）

**コスト**: $0（無料）

### 4. 基本CloudWatchメトリクス

**選択理由**:
- 無料
- 基本的な監視が可能

**提供されるメトリクス**:
- ConsumedReadCapacityUnits
- ConsumedWriteCapacityUnits
- UserErrors
- SystemErrors
- ThrottledRequests

**コスト**: $0（無料）

### 5. コスト配分タグ

**選択理由**:
- コスト追跡に必須
- 追加コストなし

**実装するタグ**:
- `Environment`: dev/staging/production
- `Project`: spec-kit
- `ManagedBy`: CDK
- `CostCenter`: [部門名]

**コスト**: $0（無料）

## コスト見積もり

### 開発環境（dev）

| リソース | 想定使用量 | 単価 | 月額コスト |
|---------|-----------|------|-----------|
| DynamoDB テーブル（ストレージ） | 1 GB | $0.25/GB | $0.25 |
| DynamoDB 書き込みリクエスト | 100 req | $1.25/1M req | $0.0001 |
| DynamoDB 読み取りリクエスト | 1,000 req | $0.25/1M req | $0.0002 |
| PITR | 1 GB | $0.20/GB | $0.20 |
| CloudWatch メトリクス（基本） | 標準 | 無料 | $0.00 |
| CloudWatch ログ | 100 MB | $0.50/GB | $0.05 |
| **合計** | - | - | **約 $0.50/月** |

### ステージング環境（staging）

| リソース | 想定使用量 | 単価 | 月額コスト |
|---------|-----------|------|-----------|
| DynamoDB テーブル（ストレージ） | 5 GB | $0.25/GB | $1.25 |
| DynamoDB 書き込みリクエスト | 10,000 req | $1.25/1M req | $0.01 |
| DynamoDB 読み取りリクエスト | 50,000 req | $0.25/1M req | $0.01 |
| PITR | 5 GB | $0.20/GB | $1.00 |
| CloudWatch メトリクス（基本） | 標準 | 無料 | $0.00 |
| CloudWatch ログ | 500 MB | $0.50/GB | $0.25 |
| **合計** | - | - | **約 $2.52/月** |

### 年間総コスト（dev + staging）

```
月額: $0.50 + $2.52 = $3.02
年額: $3.02 × 12 = $36.24
```

## 除外した機能を実装した場合のコスト増加

### CloudWatchアラーム

| 項目 | 数量 | 単価 | 月額コスト |
|------|------|------|-----------|
| スロットルアラーム（読み取り） | 2環境 | $0.10/アラーム | $0.20 |
| スロットルアラーム（書き込み） | 2環境 | $0.10/アラーム | $0.20 |
| システムエラーアラーム | 2環境 | $0.10/アラーム | $0.20 |
| ユーザーエラーアラーム | 2環境 | $0.10/アラーム | $0.20 |
| **アラーム合計** | 8アラーム | - | **$0.80/月** |

### SNS通知

| 項目 | 数量 | 単価 | 月額コスト |
|------|------|------|-----------|
| Email通知 | 100通 | $0.00/100通 | $0.00 |
| SNSトピック | 2トピック | $0.00 | $0.00 |
| **SNS合計** | - | - | **$0.00** |

### 詳細モニタリング

| 項目 | 数量 | 単価 | 月額コスト |
|------|------|------|-----------|
| カスタムメトリクス | 10メトリクス | $0.30/メトリクス | $3.00 |
| 詳細モニタリング | 2テーブル | $0.10/テーブル | $0.20 |
| **モニタリング合計** | - | - | **$3.20/月** |

### 総コスト増加

```
アラーム: $0.80/月
SNS: $0.00/月
詳細モニタリング: $3.20/月
--------------------------
合計増加: $4.00/月（約133%増）

年間増加: $4.00 × 12 = $48.00
```

## モニタリング戦略（コスト最小版）

### 1. CloudWatchコンソールでの手動確認

**頻度**: 週1回
**確認項目**:
- ThrottledRequests（スロットルイベント）
- UserErrors（クライアントエラー）
- SystemErrors（サーバーエラー）
- ConsumedCapacity（使用量トレンド）

### 2. CloudWatch Logs Insights

**頻度**: 問題発生時
**用途**:
- エラーログの分析
- パフォーマンス調査

**コスト**: クエリ実行時のみ（少額）

### 3. AWS Cost Explorer

**頻度**: 月1回
**確認項目**:
- 月次コスト
- タグ別コスト配分
- コストトレンド

**コスト**: 無料

### 4. GitHub Actionsログ

**頻度**: デプロイ時
**確認項目**:
- デプロイ成功/失敗
- エラーメッセージ
- 実行時間

**コスト**: 無料（GitHub提供）

## 将来の拡張計画

### フェーズ1: 初期リリース（現在）

- ✅ 最小限のリソース
- ✅ 基本メトリクスのみ
- ✅ 手動モニタリング
- **想定コスト**: $3/月

### フェーズ2: 本番環境準備

- [ ] CloudWatchアラーム追加（重要なもののみ）
- [ ] SNS Email通知
- [ ] コストアラート
- **想定コスト**: $5-7/月

### フェーズ3: 本番稼働

- [ ] 詳細モニタリング（本番のみ）
- [ ] カスタムメトリクス
- [ ] ダッシュボード作成
- **想定コスト**: $10-15/月

## コスト最適化のベストプラクティス

### 1. タグの徹底

すべてのリソースに以下のタグを付与:
```typescript
tags: {
  Environment: environment,
  Project: 'spec-kit',
  ManagedBy: 'CDK',
  CostCenter: 'Engineering',
}
```

### 2. 定期的なコストレビュー

- 月次: AWS Cost Explorerで確認
- 四半期: コスト削減施策の検討
- 年次: アーキテクチャ全体の見直し

### 3. 無料枠の活用

- DynamoDBの無料枠（月25 WCU、25 RCU、25 GB）を確認
- CloudWatchの無料枠（基本メトリクス、10カスタムメトリクス）を活用

### 4. 不要なリソースの削除

- テスト環境は使用後に削除
- 古いCloudFormationスタックの削除
- 未使用のログストリームの削除

## まとめ

初期段階では、以下の方針でコストを最小化します：

1. **CloudWatchアラームは実装しない**（月$0.80削減）
2. **詳細モニタリングは実装しない**（月$3.20削減）
3. **基本メトリクスと手動確認で運用**（無料）
4. **段階的に監視機能を追加**（ビジネス成長に合わせて）

**初期コスト**: 約$3/月
**将来コスト**: 約$10-15/月（本番稼働時）
**年間削減額**: 約$48（初期段階で監視機能を除外することで）

この戦略により、システムの基本機能を維持しながら、初期コストを最小限に抑えることができます。
