---
description: タスク生成後、spec.md、plan.md、tasks.md の3つのコアアーティファクトにわたる非破壊的なクロスアーティファクト一貫性と品質分析を実行します。
scripts:
  sh: scripts/bash/check-prerequisites.sh --json --require-tasks --include-tasks
  ps: scripts/powershell/check-prerequisites.ps1 -Json -RequireTasks -IncludeTasks
---

## ユーザー入力

```text
$ARGUMENTS
```

空でない場合、続行する前にユーザー入力を **必ず** 考慮してください。

## 目標

実装前に、3つのコアアーティファクト（`spec.md`、`plan.md`、`tasks.md`）全体で、不整合、重複、曖昧さ、および不十分な仕様項目を特定します。このコマンドは、`/speckit.tasks`が完全な`tasks.md`を正常に生成した後にのみ実行する必要があります。

## 動作制約

**厳密に読み取り専用**: ファイルを **変更しないでください**。構造化された分析レポートを出力します。オプションの修復計画を提供します（ユーザーが明示的に承認する前に、後続の編集コマンドが手動で呼び出されます）。

**憲法の権威**: プロジェクト憲法（`/memory/constitution.md`）は、この分析範囲内で **交渉の余地がありません**。憲法との競合は自動的にCRITICALとなり、原則の希釈、再解釈、または黙認ではなく、仕様、計画、またはタスクの調整が必要です。原則自体を変更する必要がある場合は、`/speckit.analyze`の外で個別の明示的な憲法更新が行われる必要があります。

## 実行ステップ

### 1. 分析コンテキストの初期化

リポジトリルートから`{SCRIPT}`を一度実行し、FEATURE_DIRとAVAILABLE_DOCSのJSONを解析します。絶対パスを導出：

- SPEC = FEATURE_DIR/spec.md
- PLAN = FEATURE_DIR/plan.md
- TASKS = FEATURE_DIR/tasks.md

必要なファイルが見つからない場合はエラーメッセージで中止します（ユーザーに不足している前提条件コマンドの実行を指示します）。
引数内のシングルクォート（例: "I'm Groot"）の場合、エスケープ構文を使用: 例 'I'\''m Groot' (または可能であれば二重引用符: "I'm Groot")

### 2. アーティファクトの読み込み（段階的な開示）

各アーティファクトから必要最小限のコンテキストのみを読み込みます：

**spec.mdから:**

- 概要/コンテキスト
- 機能要件
- 非機能要件
- ユーザーストーリー
- エッジケース（存在する場合）

**plan.mdから:**

- アーキテクチャ/スタックの選択
- データモデル参照
- フェーズ
- 技術的制約

**tasks.mdから:**

- タスクID
- 説明
- フェーズのグループ化
- 並行マーカー [P]
- 参照されるファイルパス

**憲法から:**

- 原則検証のために`/memory/constitution.md`を読み込みます

### 3. セマンティックモデルの構築

内部表現を作成します（出力に生のアーティファクトを含めないでください）：

- **要件インベントリ**: 安定したキーを持つ各機能要件と非機能要件（命令句に基づいてスラッグを導出。例: "User can upload file" → `user-can-upload-file`）
- **ユーザーストーリー/アクションインベントリ**: 受け入れ基準を持つ個別のユーザーアクション
- **タスクカバレッジマッピング**: 各タスクを1つ以上の要件またはストーリーにマッピング（キーワードまたはIDやキーフレーズなどの明示的な参照パターンによる推論）
- **憲法ルールセット**: 原則名とMUST/SHOULD規範的ステートメントを抽出

### 4. 検出パス（トークン効率的な分析）

高シグナルの発見に焦点を当てます。合計50件までの発見に制限。残りはオーバーフロー概要で集約します。

#### A. 重複検出

- ほぼ重複する要件を特定
- 統合のために低品質な表現をマーク

#### B. 曖昧さ検出

- 測定可能な基準を欠いた曖昧な形容詞（fast、scalable、secure、intuitive、robust）をフラグ
- 未解決のプレースホルダー（TODO、TKTK、???、`<placeholder>`など）をフラグ

#### C. 不十分な仕様

- 動詞を持つが対象または測定可能な結果が欠けている要件
- 受け入れ基準との整合性が欠けているユーザーストーリー
- 仕様/計画で定義されていないファイルまたはコンポーネントを参照するタスク

#### D. 憲法との整合性

- MUST原則と競合する要件または計画要素
- 憲法から義務付けられたセクションまたは品質ゲートの欠如

#### E. カバレッジギャップ

- 関連タスクがゼロの要件
- マッピングされた要件/ストーリーがないタスク
- タスクに反映されていない非機能要件（例：パフォーマンス、セキュリティ）

#### F. 不整合

- 用語のドリフト（ファイル間で異なる名前を持つ同じ概念）
- 計画で参照されているが仕様にないデータエンティティ（またはその逆）
- タスクの順序の矛盾（例：依存関係の記載なしに基盤セットアップタスクの前の統合タスク）
- 競合する要件（例：一方はNext.jsを要求し、もう一方はVueを指定）

### 5. 重要度の割り当て

発見の優先順位付けには、このヒューリスティックを使用します：

- **CRITICAL**: 憲法のMUSTに違反、コア仕様アーティファクトの欠落、またはベースライン機能をブロックするカバレッジゼロの要件
- **HIGH**: 重複または競合する要件、曖昧なセキュリティ/パフォーマンス属性、テスト不可能な受け入れ基準
- **MEDIUM**: 用語のドリフト、非機能タスクカバレッジの欠如、不十分に指定されたエッジケース
- **LOW**: スタイル/表現の改善、実行順序に影響しない軽微な冗長性

### 6. コンパクトな分析レポートの作成

Markdownレポート（ファイルへの書き込みなし）を以下の構造で出力：

## 仕様分析レポート

| ID | カテゴリ | 重要度 | 場所 | 概要 | 推奨事項 |
|----|----------|----------|-------------|---------|----------------|
| A1 | 重複 | HIGH | spec.md:L120-134 | 2つの類似要件... | 表現をマージし、明確なバージョンを保持 |

（発見ごとに1行を追加。カテゴリの頭文字をプレフィックスとする安定したIDを生成）

**カバレッジ概要テーブル:**

| 要件キー | タスクあり? | タスクID | 注記 |
|-----------------|-----------|----------|-------|

**憲法整合性の問題:** (ある場合)

**マッピングされていないタスク:** (ある場合)

**メトリクス:**

- 合計要件数
- 合計タスク数
- カバレッジ % (>=1タスクを持つ要件)
- 曖昧さカウント
- 重複カウント
- クリティカル問題カウント

### 7. 次のアクションの提供

レポートの最後に、簡潔な次のアクションブロックを出力：

- CRITICAL問題が存在する場合: `/speckit.implement`の前に解決することを推奨
- LOW/MEDIUMのみの場合: ユーザーは続行可能だが、改善提案を提供
- 明示的なコマンド提案を提供: 例: "改良を含む/speckit.specifyを実行"、"アーキテクチャを調整するために/speckit.planを実行"、"'performance-metrics'のカバレッジを追加するためにtasks.mdを手動編集"

### 8. 修復の提供

ユーザーに問う: "上位N件の問題について具体的な修復編集を提案しますか？"（自動的には適用しないでください。）

## 動作原則

### コンテキスト効率

- **最小限の高シグナルトークン**: 網羅的なドキュメントではなく、実行可能な発見に焦点を当てる
- **段階的な開示**: アーティファクトを段階的に読み込む。すべてのコンテンツを分析にダンプしない
- **トークン効率的な出力**: 発見テーブルを50行に制限。オーバーフローを要約
- **決定論的な結果**: 変更なしで再実行すると、一貫したIDとカウントが生成されるべき

### 分析ガイドライン

- **ファイルを変更しない**（これは読み取り専用の分析です）
- **欠落しているセクションを幻覚しない**（存在しない場合は、正確に報告）
- **憲法違反を優先**（これらは常にCRITICAL）
- **網羅的なルールよりも例を使用**（汎用パターンではなく、特定のインスタンスを引用）
- **ゼロ問題を優雅に報告**（カバレッジ統計を含む成功レポートを発行）

## コンテキスト

{ARGS}
