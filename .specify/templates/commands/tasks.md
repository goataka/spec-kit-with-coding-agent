---
description: 利用可能な設計アーティファクトに基づいて、機能のための実行可能で依存関係順序付けされたtasks.mdを生成します。
handoffs: 
  - label: 一貫性の分析
    agent: speckit.analyze
    prompt: 一貫性のためのプロジェクト分析を実行
    send: true
  - label: プロジェクトを実装
    agent: speckit.implement
    prompt: フェーズで実装を開始
    send: true
scripts:
  sh: scripts/bash/check-prerequisites.sh --json
  ps: scripts/powershell/check-prerequisites.ps1 -Json
---

## ユーザー入力

```text
$ARGUMENTS
```

空でない場合、続行する前にユーザー入力を **必ず** 考慮してください。

## 概要

1. **セットアップ**: リポジトリルートから`{SCRIPT}`を実行し、FEATURE_DIRとAVAILABLE_DOCSリストを解析します。すべてのパスは絶対パスである必要があります。引数内のシングルクォート（例: "I'm Groot"）の場合、エスケープ構文を使用: 例 'I'\''m Groot' (または可能であれば二重引用符: "I'm Groot")

2. **設計ドキュメントの読み込み**: FEATURE_DIRから読み取り：
   - **必須**: plan.md（技術スタック、ライブラリ、構造）、spec.md（優先度付きユーザーストーリー）
   - **オプション**: data-model.md（エンティティ）、contracts/（APIエンドポイント）、research.md（決定）、quickstart.md（テストシナリオ）
   - 注記: すべてのプロジェクトがすべてのドキュメントを持っているわけではありません。利用可能なものに基づいてタスクを生成します。

3. **タスク生成ワークフローの実行**:
   - plan.mdを読み込み、技術スタック、ライブラリ、プロジェクト構造を抽出
   - spec.mdを読み込み、優先度（P1、P2、P3など）付きのユーザーストーリーを抽出
   - data-model.mdが存在する場合: エンティティを抽出してユーザーストーリーにマッピング
   - contracts/が存在する場合: エンドポイントをユーザーストーリーにマッピング
   - research.mdが存在する場合: セットアップタスクの決定を抽出
   - ユーザーストーリーごとに整理されたタスクを生成（以下のタスク生成ルールを参照）
   - ユーザーストーリーの完了順序を示す依存関係グラフを生成
   - ユーザーストーリーごとに並行実行例を作成
   - タスクの完全性を検証（各ユーザーストーリーに必要なすべてのタスクがあり、独立してテスト可能）

4. **tasks.mdの生成**: 構造として`templates/tasks-template.md`を使用し、以下で埋めます：
   - plan.mdからの正しい機能名
   - Phase 1: セットアップタスク（プロジェクト初期化）
   - Phase 2: 基盤タスク（すべてのユーザーストーリーのブロッキング前提条件）
   - Phase 3+: ユーザーストーリーごとに1つのフェーズ（spec.mdの優先順位順）
   - 各フェーズに含まれるもの: ストーリー目標、独立テスト基準、テスト（要求された場合）、実装タスク
   - 最終フェーズ: 仕上げと横断的関心事
   - すべてのタスクは厳密なチェックリスト形式に従う必要があります（以下のタスク生成ルールを参照）
   - 各タスクの明確なファイルパス
   - ストーリー完了順序を示す依存関係セクション
   - ストーリーごとの並行実行例
   - 実装戦略セクション（MVPファースト、段階的デリバリー）

5. **レポート**: 生成されたtasks.mdへのパスと要約を出力：
   - 合計タスク数
   - ユーザーストーリーごとのタスク数
   - 特定された並行実行の機会
   - 各ストーリーの独立テスト基準
   - 提案されたMVPスコープ（通常はユーザーストーリー1のみ）
   - フォーマット検証: すべてのタスクがチェックリスト形式（チェックボックス、ID、ラベル、ファイルパス）に従うことを確認

タスク生成のコンテキスト: {ARGS}

tasks.mdはすぐに実行可能である必要があります - 各タスクはLLMが追加のコンテキストなしで完了できるほど具体的である必要があります。

## タスク生成ルール

**重要**: タスクは独立した実装とテストを可能にするために、ユーザーストーリーごとに整理する必要があります。

**テストはオプション**: 機能仕様で明示的に要求された場合、またはユーザーがTDDアプローチを要求した場合にのみ、テストタスクを生成します。

### チェックリスト形式（必須）

すべてのタスクはこの形式に厳密に従う必要があります：

```text
- [ ] [TaskID] [P?] [Story?] Description with file path
```

**形式コンポーネント**:

1. **チェックボックス**: 常に`- [ ]`（マークダウンチェックボックス）で開始
2. **タスクID**: 実行順序の連番（T001、T002、T003...）
3. **[P]マーカー**: タスクが並行化可能な場合のみ含める（異なるファイル、未完了タスクへの依存関係なし）
4. **[Story]ラベル**: ユーザーストーリーフェーズタスクのみ必須
   - 形式: [US1]、[US2]、[US3]など（spec.mdのユーザーストーリーにマッピング）
   - セットアップフェーズ: ストーリーラベルなし
   - 基盤フェーズ: ストーリーラベルなし
   - ユーザーストーリーフェーズ: ストーリーラベル必須
   - 仕上げフェーズ: ストーリーラベルなし
5. **説明**: 正確なファイルパスを含む明確なアクション

**例**:

- ✅ 正しい: `- [ ] T001 実装計画に従ってプロジェクト構造を作成`
- ✅ 正しい: `- [ ] T005 [P] src/middleware/auth.pyに認証ミドルウェアを実装`
- ✅ 正しい: `- [ ] T012 [P] [US1] src/models/user.pyにUserモデルを作成`
- ✅ 正しい: `- [ ] T014 [US1] src/services/user_service.pyにUserServiceを実装`
- ❌ 間違い: `- [ ] Userモデルを作成`（IDとストーリーラベルが欠落）
- ❌ 間違い: `T001 [US1] モデルを作成`（チェックボックスが欠落）
- ❌ 間違い: `- [ ] [US1] Userモデルを作成`（タスクIDが欠落）
- ❌ 間違い: `- [ ] T001 [US1] モデルを作成`（ファイルパスが欠落）

### タスク編成

1. **ユーザーストーリーから（spec.md）** - 主要な編成:
   - 各ユーザーストーリー（P1、P2、P3...）は独自のフェーズを取得
   - すべての関連コンポーネントをストーリーにマッピング：
     - そのストーリーに必要なモデル
     - そのストーリーに必要なサービス
     - そのストーリーに必要なエンドポイント/UI
     - テストが要求された場合: そのストーリー固有のテスト
   - ストーリーの依存関係をマーク（ほとんどのストーリーは独立しているべき）

2. **コントラクトから**:
   - 各コントラクト/エンドポイント → それがサービスするユーザーストーリーへ
   - テストが要求された場合: 各コントラクト → そのストーリーのフェーズの実装前にコントラクトテストタスク[P]

3. **データモデルから**:
   - 各エンティティをそれを必要とするユーザーストーリーにマッピング
   - エンティティが複数のストーリーにサービスする場合: 最も早いストーリーまたはセットアップフェーズに配置
   - 関係 → 適切なストーリーフェーズのサービス層タスク

4. **セットアップ/インフラから**:
   - 共有インフラ → セットアップフェーズ（Phase 1）
   - 基盤/ブロッキングタスク → 基盤フェーズ（Phase 2）
   - ストーリー固有のセットアップ → そのストーリーのフェーズ内

### フェーズ構造

- **Phase 1**: セットアップ（プロジェクト初期化）
- **Phase 2**: 基盤（ブロッキング前提条件 - ユーザーストーリーの前に完了する必要がある）
- **Phase 3+**: 優先順位順のユーザーストーリー（P1、P2、P3...）
  - 各ストーリー内: テスト（要求された場合） → モデル → サービス → エンドポイント → 統合
  - 各フェーズは完全で独立してテスト可能なインクリメントである必要があります
- **最終フェーズ**: 仕上げと横断的関心事
